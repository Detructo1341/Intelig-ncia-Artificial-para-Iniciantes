<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Oito-N: Workflow Automation Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Rubik:wght{500;700}&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --node-header-height: 40px;
            --grid-size: 20px;
            --grid-color: #333;
            --bg-color: #1e1e1e;
            /* Darker background */
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--bg-color);
            color: #eee;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Grid Background - Adjusted for darker theme */
        .canvas-bg {
            background-image:
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
            width: 100vw;
            height: 100vh;
            position: absolute;
            z-index: 0;
        }

        /* Node Styles */
        .node {
            position: absolute;
            width: 220px;
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 10;
            border: 1px solid #444;
            transition: box-shadow 0.2s, border-color 0.2s;
            user-select: none;
        }

        .node:hover {
            border-color: #666;
        }

        .node.selected {
            border-color: #ff6d5a;
            /* n8n orangeish */
            box-shadow: 0 0 0 2px rgba(255, 109, 90, 0.3);
        }

        .node-header {
            height: var(--node-header-height);
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-family: 'Rubik', sans-serif;
            font-weight: 500;
            font-size: 14px;
            cursor: grab;
            position: relative;
        }

        .node-header i {
            margin-right: 8px;
        }

        .node-body {
            padding: 10px;
            font-size: 12px;
            color: #aaa;
        }

        /* Node Colors */
        .node.webhook .node-header {
            background: #22c55e;
            color: white;
        }

        .node.gemini .node-header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
        }

        .node.code .node-header {
            background: #f59e0b;
            color: #1f2937;
        }

        .node.debug .node-header {
            background: #ef4444;
            color: white;
        }

        .node.running {
            box-shadow: 0 0 15px #22c55e;
            border-color: #22c55e;
        }

        .node.error {
            border-color: red;
            box-shadow: 0 0 15px red;
        }

        /* Handles (Connectors) */
        .handle {
            width: 12px;
            height: 12px;
            background: #999;
            border-radius: 50%;
            position: absolute;
            top: calc(var(--node-header-height) / 2 - 6px);
            cursor: crosshair;
            transition: background 0.2s, transform 0.2s;
            z-index: 20;
        }

        .handle:hover {
            background: white;
            transform: scale(1.2);
        }

        .handle-input {
            left: -6px;
        }

        .handle-output {
            right: -6px;
        }

        /* SVG Connections */
        svg.connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: visible;
        }

        path.connection {
            fill: none;
            stroke: #999;
            stroke-width: 3px;
            transition: stroke 0.2s;
        }

        path.connection.active {
            stroke: #ff6d5a;
            stroke-dasharray: 8;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -20;
            }
        }

        /* Sidebar/Properties Panel */
        .sidebar {
            position: absolute;
            right: 0;
            top: 0;
            width: 320px;
            height: 100vh;
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 20px;
            z-index: 50;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .toolbar {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #2d2d2d;
            padding: 10px;
            border-radius: 8px;
            z-index: 50;
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
        }

        .btn {
            background: #444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #555;
        }

        .btn-primary {
            background: #ff6d5a;
            color: white;
            font-weight: bold;
        }

        .btn-primary:hover {
            background: #e05e4d;
        }

        /* Execution Log Modal */
        .exec-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 300px;
            background: #111;
            border-top: 2px solid #ff6d5a;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .exec-modal.open {
            transform: translateY(0);
        }

        .exec-header {
            padding: 10px 20px;
            background: #1c1c1c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .exec-content {
            padding: 20px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #0f0;
            white-space: pre-wrap;
        }

        .log-error {
            color: #f00;
        }

        textarea.code-editor {
            width: 100%;
            height: 150px;
            background: #111;
            color: #eee;
            border: 1px solid #444;
            padding: 10px;
            font-family: monospace;
            border-radius: 4px;
            margin-top: 10px;
            resize: vertical;
        }

        input.text-input {
            background: #111;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
            color: #eee;
            width: 100%;
        }
    </style>
</head>

<body onclick="closeSidebar()">

    <div class="canvas-bg"></div>

    <svg class="connections" id="connectionsLayer"></svg>

    <div class="toolbar">
        <div class="text-orange-500 font-bold mr-2 flex items-center"><i class="fa-solid fa-infinity mr-2"></i>N-Oito-N
            Lite</div>
        <input type="text" id="workflowNameInput" class="text-input p-1" style="width: 150px;"
            value="Workflow Sem Nome">
        <div class="w-px bg-gray-600 mx-2"></div>
        <button class="btn" onclick="addNode('webhook')"><i class="fa-solid fa-bolt"></i> Start</button>
        <button class="btn" onclick="addNode('gemini')"><i class="fa-solid fa-brain"></i> Gemini AI</button>
        <button class="btn" onclick="addNode('code')"><i class="fa-solid fa-code"></i> JavaScript</button>
        <button class="btn" onclick="addNode('debug')"><i class="fa-solid fa-terminal"></i> Output</button>
        <div class="w-px bg-gray-600 mx-2"></div>
        <button class="btn btn-primary" id="runBtn" onclick="runWorkflow()"><i class="fa-solid fa-play"></i> Executar
            Workflow</button>
    </div>

    <!-- Container dos N√≥s -->
    <div id="nodeContainer"></div>

    <!-- Painel de Propriedades Lateral -->
    <div class="sidebar" id="sidebar" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white" id="sidebarTitle">Propriedades</h2>
            <button onclick="closeSidebar()" class="text-gray-400 hover:text-white"><i
                    class="fa-solid fa-times"></i></button>
        </div>
        <div id="sidebarContent" class="overflow-y-auto flex-grow">
            <!-- Conte√∫do din√¢mico -->
        </div>
        <div class="mt-4 flex-shrink-0">
            <button class="btn btn-primary w-full" onclick="saveNodeSettings()">Salvar Configura√ß√£o</button>
        </div>
    </div>

    <!-- Modal de Logs de Execu√ß√£o -->
    <div class="exec-modal" id="execModal">
        <div class="exec-header">
            <span class="font-bold text-orange-500"><i class="fa-solid fa-list-check mr-2"></i>Logs de Execu√ß√£o</span>
            <button onclick="toggleExecModal(false)" class="text-white"><i
                    class="fa-solid fa-chevron-down"></i></button>
        </div>
        <div class="exec-content" id="execLog">
            Aguardando execu√ß√£o...
        </div>
    </div>

    <script>
        // --- Configura√ß√£o e Estado da Aplica√ß√£o ---

        // A API Key ser√° injetada automaticamente pelo ambiente Canvas.
        // Se estiver a exportar este c√≥digo, substitua a string vazia pela sua chave real.
        const API_KEY = "";

        const state = {
            nodes: [],
            connections: [],
            draggingNode: null,
            dragOffset: { x: 0, y: 0 },
            connectingSource: null,
            tempLine: null,
            selectedNodeId: null,
            workflowName: 'Workflow Sem Nome'
        };

        // --- Componentes DOM ---
        const nodeContainer = document.getElementById('nodeContainer');
        const connectionsLayer = document.getElementById('connectionsLayer');
        const sidebar = document.getElementById('sidebar');
        const sidebarTitle = document.getElementById('sidebarTitle');
        const sidebarContent = document.getElementById('sidebarContent');
        const execModal = document.getElementById('execModal');
        const execLog = document.getElementById('execLog');
        const workflowNameInput = document.getElementById('workflowNameInput');

        // --- 1. L√≥gica dos N√≥s ---

        function createId() { return Math.random().toString(36).substr(2, 6); }

        const nodeTypes = {
            webhook: { label: 'Start Trigger', icon: 'fa-bolt', color: 'webhook', inputs: 0, outputs: 1, data: { json: '{"message": "Ol√° Mundo. Por favor, traduza para Franc√™s"}' } },
            gemini: { label: 'Gemini AI', icon: 'fa-brain', color: 'gemini', inputs: 1, outputs: 1, data: { prompt: 'Traduza o seguinte texto para a l√≠ngua especificada: {{message}}', outputVar: 'ai_result' } },
            code: { label: 'JavaScript Code', icon: 'fa-code', color: 'code', inputs: 1, outputs: 1, data: { code: 'items[0].processed = true;\nitems[0].charCount = items[0].ai_result ? items[0].ai_result.length : 0;\nreturn items;' } },
            debug: { label: 'Final Output', icon: 'fa-terminal', color: 'debug', inputs: 1, outputs: 0, data: {} }
        };

        function addNode(type) {
            const id = createId();
            const def = nodeTypes[type];
            const x = 50 + (state.nodes.length % 5) * 20;
            const y = 50 + (Math.floor(state.nodes.length / 5)) * 20;

            const node = {
                id, type, x, y,
                data: JSON.parse(JSON.stringify(def.data)), // Deep clone defaults
                inputs: def.inputs,
                outputs: def.outputs
            };

            state.nodes.push(node);
            renderNode(node, def);
            updateConnections();
        }

        function renderNode(node, def) {
            let el = document.getElementById(node.id);
            if (!el) {
                el = document.createElement('div');
                el.className = `node ${def.color}`;
                el.id = node.id;

                // Events
                const header = document.createElement('div');
                header.className = 'node-header';
                header.onmousedown = (e) => startDrag(e, node);
                header.innerHTML = `<i class="fa-solid ${def.icon}"></i> ${def.label}`;
                el.appendChild(header);

                const body = document.createElement('div');
                body.className = 'node-body';
                body.innerHTML = `ID: ${node.id}`;
                el.appendChild(body);

                // Add Inputs
                if (node.inputs > 0) {
                    const inputHandle = document.createElement('div');
                    inputHandle.className = 'handle handle-input';
                    inputHandle.dataset.nodeId = node.id;
                    inputHandle.dataset.type = 'input';
                    inputHandle.onmouseup = (e) => handleMouseUpOnHandle(e, node.id);
                    el.appendChild(inputHandle);
                }

                // Add Outputs
                if (node.outputs > 0) {
                    const outputHandle = document.createElement('div');
                    outputHandle.className = 'handle handle-output';
                    outputHandle.dataset.nodeId = node.id;
                    outputHandle.dataset.type = 'output';
                    outputHandle.onmousedown = (e) => handleMouseDownOnHandle(e, node.id);
                    el.appendChild(outputHandle);
                }

                el.onclick = (e) => selectNode(node.id, e);
                nodeContainer.appendChild(el);
            }

            // Update position
            el.style.left = node.x + 'px';
            el.style.top = node.y + 'px';

            // Ensure initial classes are set correctly
            el.classList.remove('running', 'error');
        }

        // --- 2. Movimenta√ß√£o (Drag & Drop) ---

        function startDrag(e, node) {
            if (e.target.classList.contains('handle')) return;
            e.stopPropagation();
            state.draggingNode = node;
            state.dragOffset = {
                x: e.clientX - node.x,
                y: e.clientY - node.y
            };
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if (!state.draggingNode) return;

            const node = state.draggingNode;
            node.x = e.clientX - state.dragOffset.x;
            node.y = e.clientY - state.dragOffset.y;

            const el = document.getElementById(node.id);
            el.style.left = node.x + 'px';
            el.style.top = node.y + 'px';

            updateConnections();
        }

        function stopDrag() {
            state.draggingNode = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // --- 3. Conex√µes (Wires) ---

        function handleMouseDownOnHandle(e, nodeId) {
            e.stopPropagation();
            e.preventDefault();
            state.connectingSource = nodeId;

            // Create temp line
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("class", "connection");
            path.setAttribute("stroke", "#ff6d5a");
            path.setAttribute("stroke-width", "3");
            path.setAttribute("fill", "none");
            connectionsLayer.appendChild(path);
            state.tempLine = path;

            document.addEventListener('mousemove', onWireDrag);
            document.addEventListener('mouseup', stopWireDrag);
        }

        function onWireDrag(e) {
            if (!state.connectingSource) return;

            const sourceNode = state.nodes.find(n => n.id === state.connectingSource);
            const startX = sourceNode.x + 220;
            const startY = sourceNode.y + 20;

            const endX = e.clientX;
            const endY = e.clientY;

            const d = `M ${startX} ${startY} C ${startX + 50} ${startY}, ${endX - 50} ${endY}, ${endX} ${endY}`;
            state.tempLine.setAttribute("d", d);
        }

        function handleMouseUpOnHandle(e, targetId) {
            e.stopPropagation();
            e.preventDefault();

            if (state.connectingSource && state.connectingSource !== targetId) {
                // Check if connection already exists
                const exists = state.connections.some(c => c.source === state.connectingSource && c.target === targetId);

                if (!exists) {
                    // Create permanent connection
                    state.connections.push({
                        source: state.connectingSource,
                        target: targetId
                    });
                    updateConnections();
                    logToExec(`‚úÖ Conectado: ${state.connectingSource} -> ${targetId}`);
                }
            }
            stopWireDrag();
        }

        function stopWireDrag() {
            if (state.tempLine) {
                state.tempLine.remove();
                state.tempLine = null;
            }
            state.connectingSource = null;
            document.removeEventListener('mousemove', onWireDrag);
            document.removeEventListener('mouseup', stopWireDrag);
        }

        function updateConnections() {
            // Clear existing lines
            while (connectionsLayer.firstChild) {
                connectionsLayer.removeChild(connectionsLayer.firstChild);
            }

            state.connections.forEach(conn => {
                const sourceNode = state.nodes.find(n => n.id === conn.source);
                const targetNode = state.nodes.find(n => n.id === conn.target);
                if (!sourceNode || !targetNode) return;

                // Get node element to calculate handle position accurately
                const sourceEl = document.getElementById(conn.source);
                const targetEl = document.getElementById(conn.target);
                if (!sourceEl || !targetEl) return;

                const handleOffset = 20; // Height of handle from top of node (center of header)

                const startX = sourceNode.x + sourceEl.offsetWidth;
                const startY = sourceNode.y + handleOffset;
                const endX = targetNode.x;
                const endY = targetNode.y + handleOffset;

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("class", "connection");
                path.setAttribute("id", `conn-${conn.source}-${conn.target}`);

                // Bezier Curve Logic (smooth S-curve)
                const cp1x = startX + Math.abs(endX - startX) / 2;
                const cp2x = endX - Math.abs(endX - startX) / 2;

                const d = `M ${startX} ${startY} C ${cp1x} ${startY}, ${cp2x} ${endY}, ${endX} ${endY}`;

                path.setAttribute("d", d);
                connectionsLayer.appendChild(path);
            });
        }

        // --- 4. Sidebar & Configura√ß√£o ---

        function selectNode(id, e) {
            if (e) e.stopPropagation();

            // Visual select
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
            const el = document.getElementById(id);
            if (el) el.classList.add('selected');

            state.selectedNodeId = id;
            const node = state.nodes.find(n => n.id === id);
            openSidebar(node);
        }

        function openSidebar(node) {
            sidebarTitle.innerText = `Editar: ${nodeTypes[node.type].label}`;
            sidebar.classList.add('open');

            let html = '';

            if (node.type === 'webhook') {
                html = `
                <label class="block text-sm font-bold mb-2">JSON de In√≠cio</label>
                <textarea id="setting-json" class="code-editor">${node.data.json}</textarea>
                <p class="text-xs text-gray-500 mt-2">Simula o dado de entrada (Webhook Payload).</p>
            `;
            } else if (node.type === 'gemini') {
                html = `
                <label class="block text-sm font-bold mb-2">Prompt da IA</label>
                <textarea id="setting-prompt" class="code-editor" style="height:100px">${node.data.prompt}</textarea>
                <p class="text-xs text-gray-500 mt-2">Use <code class="text-yellow-400 text-xs">\{\{variavel\}\}</code> para inserir dados do n√≥ anterior.</p>
                <label class="block text-sm font-bold mt-4 mb-2">Vari√°vel de Sa√≠da</label>
                <input type="text" id="setting-outputVar" class="text-input" value="${node.data.outputVar}">
                <p class="text-xs text-gray-500 mt-2">Nome da vari√°vel para guardar a resposta da IA (Ex: ai_result).</p>
            `;
            } else if (node.type === 'code') {
                html = `
                <label class="block text-sm font-bold mb-2">JavaScript</label>
                <textarea id="setting-code" class="code-editor" style="height:200px">${node.data.code}</textarea>
                <p class="text-xs text-gray-500 mt-2">A vari√°vel <code class="text-yellow-400 text-xs">items</code> cont√©m o input. Retorne <code class="text-yellow-400 text-xs">items</code> (array de objetos).</p>
            `;
            } else {
                html = `<p class="text-gray-400">Este n√≥ √© um ponto de paragem/sa√≠da. N√£o requer configura√ß√£o.</p>`;
            }

            sidebarContent.innerHTML = html;
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            state.selectedNodeId = null;
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
        }

        function saveNodeSettings() {
            const node = state.nodes.find(n => n.id === state.selectedNodeId);
            if (!node) return;

            if (node.type === 'webhook') {
                node.data.json = document.getElementById('setting-json').value;
            } else if (node.type === 'gemini') {
                node.data.prompt = document.getElementById('setting-prompt').value;
                node.data.outputVar = document.getElementById('setting-outputVar').value;
            } else if (node.type === 'code') {
                node.data.code = document.getElementById('setting-code').value;
            }

            closeSidebar();
            logToExec(`Configura√ß√£o do n√≥ ${node.type} (${node.id}) salva.`);
        }

        // --- 5. Logs e Execu√ß√£o ---

        function toggleExecModal(show) {
            if (show) execModal.classList.add('open');
            else execModal.classList.remove('open');
        }

        function logToExec(msg, isError = false) {
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            line.innerHTML = `<span class="text-gray-500">[${time}]</span> ${msg}`;
            if (isError) line.classList.add('log-error');
            execLog.appendChild(line);
            execLog.scrollTop = execLog.scrollHeight;
        }

        // Fun√ß√£o de tratamento de erros com Backoff
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);

                    if (!response.ok) {
                        const errorText = await response.text();
                        // Lan√ßa erro para ser pego pelo bloco catch
                        throw new Error(`API retornou status ${response.status}: ${errorText.substring(0, 100)}...`);
                    }
                    return response;

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error; // √öltima tentativa, falha definitiva
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    logToExec(`‚ö†Ô∏è Tentativa ${attempt + 1} falhou. A tentar novamente em ${Math.round(delay / 1000)}s...`, true);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }


        async function runWorkflow() {
            toggleExecModal(true);
            execLog.innerHTML = '';
            state.nodes.forEach(n => document.getElementById(n.id).classList.remove('error'));
            logToExec(`üöÄ Iniciando Workflow: ${workflowNameInput.value}`);

            // 1. Encontrar Trigger
            const startNode = state.nodes.find(n => n.type === 'webhook');
            if (!startNode) {
                logToExec("ERRO: Nenhum n√≥ 'Start Trigger' encontrado.", true);
                return;
            }

            let queue = [{ node: startNode, inputData: [] }];
            let nodeResults = {}; // Armazena o resultado de cada n√≥ por ID

            // Simular o JSON inicial
            try {
                const initialData = JSON.parse(startNode.data.json);
                queue[0].inputData = [initialData];
            } catch (e) {
                logToExec("ERRO: JSON Inicial inv√°lido no n√≥ Start.", true);
                return;
            }

            // Implementa√ß√£o simples de fila (n√£o suporta branches complexos, mas funciona para sequ√™ncias)
            while (queue.length > 0) {
                const { node, inputData } = queue.shift();

                const el = document.getElementById(node.id);
                el.classList.add('running');
                logToExec(`\n‚ñ∂Ô∏è Executando N√≥: <strong>${node.type}</strong> (${node.id})`);
                logToExec(`   Input: ${JSON.stringify(inputData).substring(0, 150)}...`);

                let outputData = inputData; // Pass-through por defeito
                let errorFlag = false;

                try {
                    // --- L√ìGICA DE CADA N√ì ---
                    if (node.type === 'gemini') {
                        // 1. Interpolate Prompt
                        let prompt = node.data.prompt;
                        const item = inputData[0] || {};
                        for (const key in item) {
                            prompt = prompt.replace(new RegExp(`{{${key}}}`, 'g'), item[key]);
                        }

                        logToExec(`   ü§ñ Chamando Gemini API...`);

                        if (!API_KEY && !window.__initial_auth_token) {
                            throw new Error("API Key ausente. Por favor, verifique a sua configura√ß√£o de chave.");
                        }

                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

                        const response = await fetchWithBackoff(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Nenhuma resposta de texto v√°lida da IA.";

                        const outputVar = node.data.outputVar || 'ai_result';
                        outputData = [{ ...item, [outputVar]: text }];
                        logToExec(`   ‚úÖ Resposta IA armazenada em '${outputVar}': "${text.substring(0, 70)}..."`);

                    } else if (node.type === 'code') {
                        // Executa JS seguro
                        const func = new Function('items', `
                        // items √© um array de objetos (Payload do n8n)
                        ${node.data.code}
                    `);
                        outputData = func(inputData);

                        if (!Array.isArray(outputData) || typeof outputData[0] !== 'object') {
                            throw new Error("O n√≥ de c√≥digo deve retornar um array de objetos (items).");
                        }

                        logToExec(`   üíª C√≥digo Executado. Itens de Sa√≠da: ${outputData.length}`);

                    } else if (node.type === 'webhook') {
                        // Pass - Output √© o JSON inicial
                    }

                } catch (err) {
                    logToExec(`‚ùå ERRO no n√≥ ${node.type} (${node.id}): ${err.message}`, true);
                    errorFlag = true;
                }

                // --- L√≥gica de Continua√ß√£o e UX ---
                await new Promise(r => setTimeout(r, 800)); // Delay visual
                el.classList.remove('running');
                if (errorFlag) {
                    el.classList.add('error');
                    logToExec("üõë Execu√ß√£o parada devido a erro.", true);
                    return;
                }

                // Armazena o resultado
                nodeResults[node.id] = outputData;

                // Encontrar pr√≥ximos n√≥s (apenas se n√£o houver erro)
                const outgoingEdges = state.connections.filter(c => c.source === node.id);

                if (outgoingEdges.length === 0) {
                    logToExec("\nüèÅ Fim do Fluxo. N√≥ de Sa√≠da Atingido.");
                    logToExec(`<strong>RESULTADO FINAL:</strong>`);
                    logToExec(JSON.stringify(outputData, null, 2), false);
                }

                for (const edge of outgoingEdges) {
                    const targetNode = state.nodes.find(n => n.id === edge.target);

                    // Animar conex√£o
                    const connPath = document.getElementById(`conn-${edge.source}-${edge.target}`);
                    if (connPath) {
                        connPath.classList.add('active');
                        setTimeout(() => connPath.classList.remove('active'), 1000);
                    }

                    // Passa uma c√≥pia dos dados de sa√≠da para o pr√≥ximo n√≥
                    queue.push({ node: targetNode, inputData: JSON.parse(JSON.stringify(outputData)) });
                }
            }
        }

        // --- Inicializa√ß√£o ---

        function initializeWorkflow() {
            state.nodes = [];
            state.connections = [];
            nodeContainer.innerHTML = '';
            execLog.innerHTML = 'Aguardando execu√ß√£o...';

            // Criar fluxo inicial para demo
            addNode('webhook');
            addNode('gemini');
            addNode('code');
            addNode('debug');

            setTimeout(() => {
                const [n1, n2, n3, n4] = state.nodes.map(n => n.id);

                // Layout inicial
                state.nodes[0].x = 100; state.nodes[0].y = 200;
                state.nodes[1].x = 400; state.nodes[1].y = 200;
                state.nodes[2].x = 700; state.nodes[2].y = 200;
                state.nodes[3].x = 1000; state.nodes[3].y = 200;

                // Conex√µes
                state.connections.push({ source: n1, target: n2 });
                state.connections.push({ source: n2, target: n3 });
                state.connections.push({ source: n3, target: n4 });

                state.nodes.forEach(n => renderNode(n, nodeTypes[n.type]));
                updateConnections();
            }, 50);
        }

        window.onload = initializeWorkflow;

    </script>
</body>

</html>